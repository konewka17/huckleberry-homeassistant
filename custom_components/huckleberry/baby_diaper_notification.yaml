# Ready-to-Use Baby Diaper Change Notification Automation
# Copy this to your automations.yaml or create via the UI

# ============================================================================
# STEP 1: Customize these values for your setup
# ============================================================================
#
# Replace the following placeholders:
# - CHILD_NAME: Your child's name (lowercase with underscores, e.g., "emma")
# - YOUR_PHONE: Your phone's name in mobile_app (e.g., "iphone" or "pixel")
# - DEVICE_ID: Your child's device ID (find in Settings â†’ Devices)
#
# Example entity: sensor.emma_last_diaper
# Example service: notify.mobile_app_iphone
# ============================================================================

- id: baby_diaper_notification
  alias: "Baby Diaper Change Reminder"
  description: "Notify after 2 hours with no diaper change, with quick action buttons"

  trigger:
    # When last diaper timestamp hasn't changed for 2 hours
    - platform: state
      entity_id: sensor.CHILD_NAME_last_diaper
      for:
        hours: 2
      id: diaper_reminder

    # When diaper is changed (via app or HA)
    - platform: state
      entity_id: sensor.CHILD_NAME_last_diaper
      id: diaper_changed

    # Notification action buttons
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_LOG_PEE"
      id: log_pee

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_LOG_POO"
      id: log_poo

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_LOG_BOTH"
      id: log_both

  condition: []

  action:
    - choose:
        # Show reminder after 2 hours without change
        - conditions:
            - condition: trigger
              id: diaper_reminder
            # Only notify if timestamp is recent (within last 24 hours)
            - condition: template
              value_template: >
                {% set timestamp = state_attr('sensor.CHILD_NAME_last_diaper', 'timestamp') | float(0) %}
                {% set hours_since = (now().timestamp() - timestamp) / 3600 %}
                {{ hours_since < 24 }}
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Diaper Change Reminder"
                message: >
                  {% set timestamp = state_attr('sensor.CHILD_NAME_last_diaper', 'timestamp') | float(0) %}
                  {% set hours_since = ((now().timestamp() - timestamp) / 3600) | round(1) %}
                  Last change: {{ hours_since }} hours ago ({{ state_attr('sensor.CHILD_NAME_last_diaper', 'type') }})
                data:
                  notification_icon: "mdi:baby"
                  tag: "baby_diaper"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_LOG_PEE"
                      title: "ðŸ’§ Pee"
                    - action: "HUCKLEBERRY_LOG_POO"
                      title: "ðŸ’© Poo"
                    - action: "HUCKLEBERRY_LOG_BOTH"
                      title: "ðŸ’§ðŸ’© Both"

        # Diaper was changed (clear notification)
        - conditions:
            - condition: trigger
              id: diaper_changed
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_diaper"

        # Log Pee button clicked
        - conditions:
            - condition: trigger
              id: log_pee
          sequence:
            - service: huckleberry.log_diaper_pee
              target:
                device_id: DEVICE_ID
            # Clear notification after logging
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_diaper"

        # Log Poo button clicked
        - conditions:
            - condition: trigger
              id: log_poo
          sequence:
            - service: huckleberry.log_diaper_poo
              target:
                device_id: DEVICE_ID
            # Clear notification after logging
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_diaper"

        # Log Both button clicked
        - conditions:
            - condition: trigger
              id: log_both
          sequence:
            - service: huckleberry.log_diaper_both
              target:
                device_id: DEVICE_ID
            # Clear notification after logging
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_diaper"

# ============================================================================
# USAGE INSTRUCTIONS:
# ============================================================================
#
# 1. Find your values:
#    - Go to Settings â†’ Devices & Services â†’ Huckleberry
#    - Click on your child's device
#    - Entity ID example: sensor.emma_last_diaper
#    - Device ID is in the URL: .../device/abc123def456
#
# 2. Replace placeholders:
#    - CHILD_NAME â†’ your child's name (e.g., "emma")
#    - YOUR_PHONE â†’ your phone identifier (e.g., "iphone")
#    - DEVICE_ID â†’ the device ID from step 2
#
# 3. Add to your automations:
#    - Copy this automation to automations.yaml
#    - OR create it via the UI (Settings â†’ Automations)
#
# 4. Test it:
#    - Wait 2 hours after last diaper change
#    - Check your phone for notification with Pee/Poo/Both buttons
#    - Tap any button to log the change
#    - Change diaper via Huckleberry app â†’ notification clears automatically
#
# Example with real values:
#   entity_id: sensor.emma_last_diaper
#   service: notify.mobile_app_iphone
#   device_id: a1b2c3d4e5f6
#
# BEHAVIOR:
# - Triggers after sensor.CHILD_NAME_last_diaper stays unchanged for 2 hours
# - Shows notification with Pee/Poo/Both buttons
# - Clicking any button logs the change and clears notification
# - Changing diaper via app automatically clears notification
#
# ============================================================================
