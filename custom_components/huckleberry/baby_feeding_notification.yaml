# Ready-to-Use Baby Feeding Notification Automation
# Copy this to your automations.yaml or create via the UI

# ============================================================================
# STEP 1: Customize these values for your setup
# ============================================================================
#
# Replace the following placeholders:
# - CHILD_NAME: Your child's name (lowercase with underscores, e.g., "emma")
# - CHILD_UID: Your child's UID (e.g., "abc123")
# - YOUR_PHONE: Your phone's name in mobile_app (e.g., "iphone" or "pixel")
# - DEVICE_ID: Your child's device ID (find in Settings → Devices)
#
# Example entity: binary_sensor.CHILD_UID_feeding_status
# Example service: notify.mobile_app_iphone
# ============================================================================

- id: baby_feeding_notification
  alias: "Baby Feeding Notification with Timer"
  description: "Display notification when baby is feeding with live timer and reminder after 2 hours"

  trigger:
    # When feeding starts
    - platform: state
      entity_id: binary_sensor.CHILD_UID_feeding_status
      to: "on"
      id: feeding_started

    # When feeding stops
    - platform: state
      entity_id: binary_sensor.CHILD_UID_feeding_status
      to: "off"
      id: feeding_stopped

    # When paused state changes
    - platform: state
      entity_id: binary_sensor.CHILD_UID_feeding_status
      attribute: is_paused
      to: true
      id: feeding_paused

    # Reminder after 2 hours since last feeding
    - platform: state
      entity_id: binary_sensor.CHILD_UID_feeding_status
      to: "off"
      for:
        hours: 2
      id: feeding_reminder

    # Notification action buttons
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_STOP_FEEDING"
      id: stop_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_PAUSE_FEEDING"
      id: pause_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_RESUME_FEEDING"
      id: resume_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_SWITCH_SIDE"
      id: switch_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_START_FEEDING_LEFT"
      id: start_left_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_START_FEEDING_RIGHT"
      id: start_right_action

  action:
    - choose:
        # Feeding started - show notification with chronometer
        - conditions:
            - condition: trigger
              id: feeding_started
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Baby feeding"
                message: >
                  Feeding {{ state_attr('binary_sensor.CHILD_UID_feeding_status', 'active_side') | title }} since {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'feeding_start') | int | timestamp_custom('%H:%M', true)) }}
                data:
                  chronometer: true
                  when: "{{ state_attr('binary_sensor.CHILD_UID_feeding_status', 'feeding_start') }}"
                  notification_icon: "mdi:baby-bottle"
                  tag: "baby_feeding"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_STOP_FEEDING"
                      title: "Stop"
                    - action: "HUCKLEBERRY_PAUSE_FEEDING"
                      title: "Pause"
                    - action: "HUCKLEBERRY_SWITCH_SIDE"
                      title: "Switch Side"

        # Feeding paused - show duration and Resume/Stop buttons
        - conditions:
            - condition: trigger
              id: feeding_paused
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Baby feeding paused"
                message: >
                  Started {{ state_attr('binary_sensor.CHILD_UID_feeding_status', 'active_side') | title }} at {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'feeding_start') | int | timestamp_custom('%H:%M', true)) }}
                  Left: {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'left_duration_seconds') | int / 60) | round(1) }} min
                  Right: {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'right_duration_seconds') | int / 60) | round(1) }} min
                data:
                  notification_icon: "mdi:pause-circle"
                  tag: "baby_feeding"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_RESUME_FEEDING"
                      title: "Resume"
                    - action: "HUCKLEBERRY_STOP_FEEDING"
                      title: "Stop"

        # Feeding stopped - clear notification immediately
        - conditions:
            - condition: trigger
              id: feeding_stopped
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_feeding"

        # Feeding reminder - show notification after 2 hours
        - conditions:
            - condition: trigger
              id: feeding_reminder
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Time to feed?"
                message: >
                  Last feeding ended at {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'last_nursing_timestamp') | int | timestamp_custom('%H:%M', true)) }}
                  Left: {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'last_nursing_left_duration') | int / 60) | round(1) }} min
                  Right: {{ (state_attr('binary_sensor.CHILD_UID_feeding_status', 'last_nursing_right_duration') | int / 60) | round(1) }} min
                data:
                  notification_icon: "mdi:baby-bottle"
                  tag: "baby_feeding"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_START_FEEDING_LEFT"
                      title: "Start Left"
                    - action: "HUCKLEBERRY_START_FEEDING_RIGHT"
                      title: "Start Right"

        # Handle Stop button
        - conditions:
            - condition: trigger
              id: stop_action
          sequence:
            - service: huckleberry.complete_feeding
              target:
                device_id: DEVICE_ID

        # Handle Pause button
        - conditions:
            - condition: trigger
              id: pause_action
          sequence:
            - service: huckleberry.pause_feeding
              target:
                device_id: DEVICE_ID

        # Handle Resume button
        - conditions:
            - condition: trigger
              id: resume_action
          sequence:
            - service: huckleberry.resume_feeding
              target:
                device_id: DEVICE_ID

        # Handle Switch Side button
        - conditions:
            - condition: trigger
              id: switch_action
          sequence:
            - service: huckleberry.switch_feeding_side
              target:
                device_id: DEVICE_ID

        # Handle Start Left button (from reminder notification)
        - conditions:
            - condition: trigger
              id: start_left_action
          sequence:
            - service: huckleberry.start_feeding
              target:
                device_id: DEVICE_ID
              data:
                side: "left"

        # Handle Start Right button (from reminder notification)
        - conditions:
            - condition: trigger
              id: start_right_action
          sequence:
            - service: huckleberry.start_feeding
              target:
                device_id: DEVICE_ID
              data:
                side: "right"
# ============================================================================
# USAGE INSTRUCTIONS:
# ============================================================================
#
# 1. Find your values:
#    - Go to Settings → Devices & Services → Huckleberry
#    - Click on your child's device
#    - Entity ID example: binary_sensor.abc123_feeding_status
#    - Device ID is in the URL: .../device/abc123def456
#
# 2. Replace placeholders:
#    - CHILD_UID → your child's UID (e.g., "abc123")
#    - YOUR_PHONE → your phone identifier (e.g., "iphone")
#    - DEVICE_ID → the device ID from step 1
#
# 3. Add to your automations:
#    - Copy this automation to automations.yaml
#    - OR create it via the UI (Settings → Automations)
#
# 4. Test it:
#    - Start feeding: huckleberry.start_feeding service
#    - Check your phone for notification with chronometer
#    - Tap "Pause" to test paused state (shows duration and Resume/Stop)
#    - Tap "Switch Side" to change sides (chronometer continues)
#    - Tap "Stop" to complete feeding
#
# Example with real values:
#   entity_id: binary_sensor.abc123_feeding_status
#   service: notify.mobile_app_iphone
#   device_id: a1b2c3d4e5f6
#
# BEHAVIOR:
# - Feeding Active: Shows chronometer with current side, Stop/Pause/Switch buttons
# - Feeding Paused: Shows "Feeding paused" with duration for each side, Resume/Stop buttons
# - Feeding Stopped: Notification clears immediately
# - After 2 hours: Shows "Time to feed?" with last feeding durations and Start Left/Right buttons
# - Start buttons clicked: Starts new feeding on selected side (replaces notification with chronometer)
#
# NOTIFICATION DETAILS:
# - Active: Shows which side is currently feeding and chronometer
# - Paused: Shows duration for left and right sides
# - Reminder: Shows last feeding end time and durations for both sides
#
# ============================================================================
