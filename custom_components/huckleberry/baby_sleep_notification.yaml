# Ready-to-Use Baby Sleep Notification Automation
# Copy this to your automations.yaml or create via the UI

# ============================================================================
# STEP 1: Customize these values for your setup
# ============================================================================
#
# Replace the following placeholders:
# - CHILD_NAME: Your child's name (lowercase with underscores, e.g., "emma")
# - YOUR_PHONE: Your phone's name in mobile_app (e.g., "iphone" or "pixel")
# - DEVICE_ID: Your child's device ID (find in Settings → Devices)
#
# Example entity: binary_sensor.emma_sleep_status
# Example service: notify.mobile_app_iphone
# ============================================================================

- id: baby_sleep_notification
  alias: "Baby Sleep Notification with Chronometer"
  description: "Display notification when baby is sleeping with live timer"

  trigger:
    # When sleep starts
    - platform: state
      entity_id: binary_sensor.CHILD_NAME_sleep_status
      to: "on"
      id: sleep_started

    # When sleep stops or pauses
    - platform: state
      entity_id: binary_sensor.CHILD_NAME_sleep_status
      to: "off"
      id: sleep_stopped
      for:
        hours: 2
        minutes: 30

    # When paused state changes
    - platform: state
      entity_id: binary_sensor.CHILD_NAME_sleep_status
      attribute: is_paused
      to: true
      id: sleep_paused

    # Notification action buttons
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_STOP_SLEEP"
      id: stop_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_PAUSE_SLEEP"
      id: pause_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_RESUME_SLEEP"
      id: resume_action

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "HUCKLEBERRY_START_SLEEP"
      id: start_action

  action:
    - choose:
        # Sleep started - show notification with chronometer
        - conditions:
            - condition: trigger
              id: sleep_started
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Baby sleep"
                message: >
                  Sleep since {{ (state_attr('binary_sensor.CHILD_NAME_sleep_status', 'timer_start_time') | int | timestamp_custom('%H:%M', true)) }}
                data:
                  chronometer: true
                  when: "{{ state_attr('binary_sensor.CHILD_NAME_sleep_status', 'timer_start_time') }}"
                  notification_icon: "mdi:sleep"
                  tag: "baby_sleep"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_STOP_SLEEP"
                      title: "Stop"
                    - action: "HUCKLEBERRY_PAUSE_SLEEP"
                      title: "Pause"

        # Sleep paused - show Resume/Stop buttons
        - conditions:
            - condition: trigger
              id: sleep_paused
          sequence:
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Baby sleep paused"
                message: >
                  Started at {{ (state_attr('binary_sensor.CHILD_NAME_sleep_status', 'timer_start_time') | int | timestamp_custom('%H:%M', true)) }}, Duration: {{ ((now().timestamp() - state_attr('binary_sensor.CHILD_NAME_sleep_status', 'timer_start_time') | int) / 60) | round(0) | int }} min
                data:
                  notification_icon: "mdi:pause-circle"
                  tag: "baby_sleep"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_RESUME_SLEEP"
                      title: "Resume"
                    - action: "HUCKLEBERRY_STOP_SLEEP"
                      title: "Stop"

        # Sleep stopped - clear notification immediately, then show wake window reminder after 2.5 hours
        - conditions:
            - condition: trigger
              id: sleep_stopped
          sequence:
            # Clear the active/paused notification first
            - service: notify.mobile_app_YOUR_PHONE
              data:
                message: "clear_notification"
                data:
                  tag: "baby_sleep"
            # Show wake window notification after 2.5 hours
            - service: notify.mobile_app_YOUR_PHONE
              data:
                title: "Time for sleep?"
                message: >
                  Last sleep ended at {{ (state_attr('binary_sensor.CHILD_NAME_sleep_status', 'last_sleep_start') | int + state_attr('binary_sensor.CHILD_NAME_sleep_status', 'last_sleep_duration_seconds') | int) | timestamp_custom('%H:%M', true) }}
                data:
                  notification_icon: "mdi:sleep"
                  tag: "baby_sleep"
                  persistent: true
                  actions:
                    - action: "HUCKLEBERRY_START_SLEEP"
                      title: "Start Sleep"

        # Handle Stop button
        - conditions:
            - condition: trigger
              id: stop_action
          sequence:
            - service: huckleberry.complete_sleep
              target:
                device_id: DEVICE_ID

        # Handle Pause button
        - conditions:
            - condition: trigger
              id: pause_action
          sequence:
            - service: huckleberry.pause_sleep
              target:
                device_id: DEVICE_ID

        # Handle Resume button
        - conditions:
            - condition: trigger
              id: resume_action
          sequence:
            - service: huckleberry.resume_sleep
              target:
                device_id: DEVICE_ID

        # Handle Start button (from wake window notification)
        - conditions:
            - condition: trigger
              id: start_action
          sequence:
            - service: huckleberry.start_sleep
              target:
                device_id: DEVICE_ID
# ============================================================================
# USAGE INSTRUCTIONS:
# ============================================================================
#
# 1. Find your values:
#    - Go to Settings → Devices & Services → Huckleberry
#    - Click on your child's device
#    - Entity ID example: binary_sensor.emma_sleep_status
#    - Device ID is in the URL: .../device/abc123def456
#
# 2. Replace placeholders:
#    - CHILD_NAME → your child's name (e.g., "emma")
#    - YOUR_PHONE → your phone identifier (e.g., "iphone")
#    - DEVICE_ID → the device ID from step 1
#
# 3. Add to your automations:
#    - Copy these two automations to automations.yaml
#    - OR create them via the UI (Settings → Automations)
#
# 4. Test it:
#    - Start sleep: huckleberry.start_sleep service
#    - Check your phone for notification with chronometer
#    - Tap "Pause" to test paused state (shows Resume/Stop buttons)
#    - Tap "Stop" to complete sleep
#
# Example with real values:
#   entity_id: binary_sensor.emma_sleep_status
#   service: notify.mobile_app_iphone
#   device_id: a1b2c3d4e5f6
#
# BEHAVIOR:
# - Sleep Active: Shows chronometer with Stop/Pause buttons
# - Sleep Paused: Shows "Sleep paused" with Resume/Stop buttons
# - Sleep Stopped: Notification clears immediately
# - After 2.5 hours awake: Shows "Time for sleep?" with Start button
# - Start button clicked: Starts new sleep (replaces notification with chronometer)
#
# ============================================================================
# 2. Replace placeholders:
#    - CHILD_NAME → your child's name (e.g., "emma")
#    - YOUR_PHONE → your phone identifier (e.g., "iphone")
#    - DEVICE_ID → the device ID from step 1
#
# 3. Add to your automations:
#    - Copy this automation to automations.yaml
#    - OR create it via the UI (Settings → Automations)
